# dd2ffu (imageapp variant) - Because it turns out 3 hours flashing isn't sane for anybody
[![Build status](https://interoptools.visualstudio.com/DD2FFU/_apis/build/status/DD2FFU-.NET%20Desktop-CI)](https://interoptools.visualstudio.com/DD2FFU/_build/latest?definitionId=7)

dd2ffu leverages imageapp's ffu capabilities to build FFU 2.0 compliant images from eMMC raw img files, flashable using Nokia's FlashApp (unsecurely) or Microsoft own FFULoader (TestSigned)

img2ffu performs the following operations to your image file:

- convertion to a vhd for modifications
- log file cleanup
- registry hive cleanup
- removes unused sectors from common accessible partitions
- file system fixes

It should be noted the tool won't modify your image file in any way shape or form.

# Getting Started
1.	Use a Windows Machine (x86, amd64, arm64) running build 9200 and higher (7600+ is untested but may work)
2.	Run the program as an administrator
3.	Ensure good enough disk space left to account for the FFU file and the VHD file (even on the Main OS drive because pass2 creates a vhd in %temp%)
4.	Read the tool help

# Command line help
```
DD2FFU 1.0.0.2
Copyright Proto Beta Test (c) 2018
ERROR(S):
Required option 'i, img-file' is missing.
Required option 'f, ffu-file' is missing.

  -i, --img-file              Required. A path to the img file to convert

  -f, --ffu-file              Required. A path to the FFU file to output

  -t, --temp                  A path to the tool temporary directory

  -l, --drive-letter          (Default: B) A drive letter that will be used during FFU generation for clean up. ie: X

  -e, --exclude-list          Path to an optional partition exclude text list to use instead of the builtin one.

  -a, --anti-theft-version    (Default: 1.1) Anti theft version.

  -o, --os-version            (Default: 10.0.11111.0) Operating system version.

  -s, --oobe-selfhost         Enable OOBE selfhost.

  -d, --disable-headless      Disable OOBE headless.

  --help                      Display this help screen.

  --version                   Display version information.
```

# Flashing guide
For most devices (retail and most prototypes using an RDC), you want generally to absolutely make sure the raw image file contains your device own:

-	DPP
-	MODEM_FSG
-	MODEM_FS1
-	MODEM_FS2
-	SSD

The FFU image that will get generated by this tool will **not** contain those partitions, and flashing the FFU image **won't** override them. There is no way for this tool to brick your device. We however recommend checking later on if those partitions have indeed been skipped by the tool, by using a program such as WPInternals with the DumpFFU command.

## Flash the image using FFULoader 
##### (WPInternals unlocked phones / Other means for an unlock / Prototypes)

-	Set FFULoader entry in BCD properly with TestSigning on.
-	Use ffutool to flash the ffu image

## Flash the image using FlashApp 
##### (Prototypes or WPInternals Spec A unlocked phones)

if your phone matches the PlatformID found by the utility (which it should):

-	thor2 -mode uefiflash -ffufile "pathto\image.ffu" -skip_id_check -show_detailed_progress

otherwise:

-	thor2 -mode uefiflash -ffufile "pathto\image.ffu" -show_detailed_progress

# Known issues
- The tool may fail shrinking the data partition. This is a required step so imageapp backbones can work and generate a correct ffu image that won't end up being corrupt. Normal FFU images are smaller than the target eMMCs to accomodate for different eMMC sizes. On first boot, this partition will get extended (properly only if the image has been captured before booting to OOBE). Right now the tool will ask you to verify this has been correctly done. A good shrink means Data should be around 1.5GB in most cases. Anything higher especially wth a Test partition layout might be abnormal, and the generation will fail for pass 2.
- The conversion process might be a bit slow on test layouts. A better way to erase partitions should be found for SVRawDump.
- OS version should be automatically gathered from target image.